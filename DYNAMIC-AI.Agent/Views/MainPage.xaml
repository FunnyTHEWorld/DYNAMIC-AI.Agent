<Page
    x:Class="DYNAMIC_AI.Agent.Views.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:helpers="using:DYNAMIC_AI.Agent.Helpers"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    mc:Ignorable="d">
    <Page.Resources>
        <DataTemplate x:Key="UserMessageTemplate">
            <Grid HorizontalAlignment="Right" Margin="5">
                <StackPanel>
                    <TextBlock Text="{Binding Content}" TextWrapping="Wrap" HorizontalAlignment="Right" />
                    <TextBlock Text="{Binding Timestamp}" FontSize="10" HorizontalAlignment="Right" />
                    <TextBlock Text="{Binding PromptTokenCount, StringFormat='Input Tokens: {0}'}" FontSize="10" HorizontalAlignment="Right" />
                </StackPanel>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="AiMessageTemplate">
            <Grid HorizontalAlignment="Left" Margin="5">
                <StackPanel>
                    <controls:MarkdownTextBlock Text="{Binding Content}" TextWrapping="Wrap" HorizontalAlignment="Left" />
                    <TextBlock Text="{Binding Timestamp}" FontSize="10" HorizontalAlignment="Left" />
                    <TextBlock Text="{Binding CandidatesTokenCount, StringFormat='Output Tokens: {0}'}" FontSize="10" HorizontalAlignment="Left" />
                </StackPanel>
            </Grid>
        </DataTemplate>

        <helpers:ChatMessageTemplateSelector x:Key="ChatMessageTemplateSelector"
                                             UserMessageTemplate="{StaticResource UserMessageTemplate}"
                                             AiMessageTemplate="{StaticResource AiMessageTemplate}" />
    </Page.Resources>

    <Grid x:Name="ContentArea">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="200" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="200" />
        </Grid.ColumnDefinitions>

        <!-- Left Pane: Conversation History (Placeholder) -->
        <Border Grid.Column="0" BorderBrush="Gray" BorderThickness="0,0,1,0">
            <TextBlock Text="Conversation History" VerticalAlignment="Center" HorizontalAlignment="Center" />
        </Border>

        <!-- Center Pane: Chat Dialog -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <ListView Grid.Row="0"
                      ItemsSource="{x:Bind ViewModel.ChatMessages}"
                      ItemTemplateSelector="{StaticResource ChatMessageTemplateSelector}"
                      SelectionMode="None" />

            <Grid Grid.Row="1" Padding="10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBox Grid.Column="0"
                         Text="{x:Bind ViewModel.UserInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         PlaceholderText="Type your message here..."
                         VerticalAlignment="Center" />
                <ProgressRing Grid.Column="1" IsActive="{x:Bind ViewModel.IsThinking, Mode=OneWay}" Margin="10,0,0,0" />
                <Button Grid.Column="2"
                        Content="Send"
                        Command="{x:Bind ViewModel.SendMessageCommand}"
                        Margin="10,0,0,0" />
            </Grid>
        </Grid>

        <!-- Right Pane: AI Model Settings -->
        <StackPanel Grid.Column="2" Padding="10" BorderBrush="Gray" BorderThickness="1,0,0,0">
            <TextBlock Text="Temperature" />
            <Slider Minimum="0" Maximum="1" StepFrequency="0.1" Value="{x:Bind ViewModel.Temperature, Mode=TwoWay}" />
            <TextBlock Text="{x:Bind ViewModel.Temperature, Mode=OneWay}" HorizontalAlignment="Center" />

            <TextBlock Text="Top-P" Margin="0,20,0,0" />
            <Slider Minimum="0" Maximum="1" StepFrequency="0.1" Value="{x:Bind ViewModel.TopP, Mode=TwoWay}" />
            <TextBlock Text="{x:Bind ViewModel.TopP, Mode=OneWay}" HorizontalAlignment="Center" />

            <ToggleSwitch Header="Thinking" IsOn="{x:Bind ViewModel.IsStreamingEnabled, Mode=TwoWay}" Margin="0,20,0,0" />
        </StackPanel>
    </Grid>
</Page>
